<<<<<<< Updated upstream
=======
local schema = require 'schema'
local Int = schema.Int
local String = schema.String
local Array = schema.Array
local Optional = schema.Optional
local registry = require 'registry'
local Uuid = registry.Uuid
local register = registry.section("account.")
local alias = registry.alias
>>>>>>> Stashed changes
local getUUID = require('uuid4').getUUID

<<<<<<< Updated upstream
return function (db, registry)
  local alias = registry.alias
  local register = registry.register
  local Optional = registry.Optional
  local String = registry.String
  local Int = registry.Int
  local Bool = registry.Bool
  local Array = registry.Array
  local Uuid = registry.Uuid
  local query = db.query
  local quote = db.quote
  local compileBlob = db.compileBlob

  local Row = alias("Row",
    "This alias is for existing Account entries that have an ID.",
    {id=Uuid,name=String})

  local RowWithoutId = alias("RowWithoutId",
    "This alias is for creating new Account entries that don't have an ID yet",
    {name=String})

  local Query = alias("Query",
    "Structure for valid query parameters",
    {
      name = Optional(String),
      start = Optional(Int),
      count = Optional(Int),
    })

  assert(register("create", [[

  This function creates a new Account entry in the database.  It will return
  the randomly generated UUID so you can reference the Account.

  ]], {{"row", RowWithoutId}}, Uuid, function (row)
    local id = getUUID()
    assert(query(string.format(
      "INSERT INTO account (id, name) VALUES (%s, %s)",
=======
local Account = alias("Account", {id=Uuid, name=String},
  "This alias is for existing account entries that have an ID.")

local AccountWithoutId = alias("AccountWithoutId", {name=String},
  "This alias creates a new account")

  local AccountQuery = alias("AccountQuery", {
      name = Optional(String),
      start = Optional(Int),
      count = Optional(Int),
    },
    "Structure for valid query parameters")


-- create({description}})
-- update({uuid,name})
-- delete(uuid)
-- query({pattern}, {limit,offset})

assert(register("create", [[

This function creates a new account entry in the database.
It will return the randomly generated UUID of the account.
]], {{"AccountWithoutId", AccountWithoutId}}, Uuid, function (account)
  local id = getUUID()
  local result = assert(query(
    string.format("INSERT INTO account ('id', 'name') VALUES ('%s', '%s')",
>>>>>>> Stashed changes
      quote(id),
      quote(row['name']))))
    return id
  end))

  assert(register("read", [[

  Given a UUID, return the corresponding row.

  ]], {{"id", Uuid}}, Optional(Row), function (id)
    local result = assert(query(string.format(
      "SELECT id, name FROM account WHERE id = %s",
      quote(id))))
    return result.rows and result.rows[1]
  end))

  assert(register("update", [[

  Update an Account row in the database.

  ]], {{"row", Row}}, Bool, function (row)
    local result = assert(query(string.format(
      "UPDATE account SET name = %s WHERE id = %s",
      quote(row['name']),
      quote(row['id']))))
    return result.summary == 'UPDATE 1'
  end))

  assert(register("delete", [[

  Remove an Account row from the database by UUID.

  ]], {{"id", Uuid}}, Bool, function (id)
    local result = assert(query(string.format(
      "DELETE FROM account WHERE id = '%s'",
<<<<<<< Updated upstream
      id)))
    return result.summary == 'DELETE 1'
  end))

  assert(register("query", [[

  Query for existing Account rows.
  Optionally you can specify a filter and/or pagination parameters.

  ]], { {"query", Query} }, {Array(Row),Int}, function (queryParameters)
    queryParameters = queryParameters or {}
    local offset = queryParameters.start or 0
    local limit = queryParameters.count or 20
    local pattern = queryParameters.name
    local where
    if pattern then
      if string.match(pattern, "*") then
        where = ' WHERE name LIKE ' .. quote(compileBlob(pattern))
      else
        where = ' WHERE name = ' .. quote(pattern)
      end
    else
      where = ''
    end
    local sql = "SELECT count(*) from account" .. where
    local result = assert(query(sql))
    local count = result.rows[1].count
    sql = 'SELECT id, name FROM account' .. where ..
      ' ORDER BY name, id' ..
      ' LIMIT ' .. limit ..
      ' OFFSET ' .. offset
    result = assert(query(sql))
    local rows = result.rows
    return {rows, count}
  end))

end
=======
      quote(id))))
  if result then
    return id
  end
  return result
end))

assert(register("query", [[

TODO: document me

]], {
  {"query", AccountQuery},
}, {Array(Account)}, function (queryParameters)
  local offset = queryParameters.start or 0
  local limit = queryParameters.count or 20
  local pattern = ''

  if queryParameters.name then
    pattern = 'WHERE name LIKE '..cleanQuery(queryParameters.name)
  end
  local sql = 'SELECT id, name FROM account '..
  pattern..
  'LIMIT '..
  limit..
  ' OFFSET '..
  offset

  return assert(query(sql)).row
end))
>>>>>>> Stashed changes
